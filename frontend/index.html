<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Proposal Generator</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container" style="max-width: 1500px;">
    <h2>AI Proposal Generator</h2>
    <section id="samples">
      <h3>Sample Proposals</h3>
      <ul id="proposal-list"></ul>
    </section>
    <section id="job-section">
      <h3>Generate 3 Proposals (Top 3 Styles with DeepSeek)</h3>
      <textarea id="job-desc" rows="5" placeholder="Paste job description here..."></textarea>
      <button id="generate-btn">Generate</button>
      <div id="error" style="display:none;" class="error"></div>
    </section>
    <div id="loading" style="display:none;">Generating proposals...</div>
    <section id="results" style="display:none;">
      <section id="analysis-section" style="margin-bottom: 32px;">
        <h3>Project Analysis</h3>
        <div class="analysis-card">
          <div style="margin-bottom: 16px;">
            <b>Client Country:</b> <span id="analysis-country"></span>
          </div>
          <div style="margin-bottom: 16px;">
            <b>Legitimacy Assessment:</b>
            <div id="analysis-legitimacy" style="margin-top: 8px; padding: 12px; background: #f8f9fa; border-radius: 4px;"></div>
          </div>
          <div style="margin-bottom: 16px;">
            <b>Pricing Analysis:</b>
            <div id="analysis-pricing" style="margin-top: 8px; padding: 12px; background: #f8f9fa; border-radius: 4px;"></div>
          </div>
          <div style="margin-bottom: 16px;">
            <b>Time Estimate:</b> <span id="analysis-time"></span>
          </div>
          <div style="margin-bottom: 16px;">
            <b>Estimated Cost (Client Country Perspective):</b> <span id="analysis-price-client"></span>
          </div>
          <div>
            <b>Estimated Cost ($20/hour):</b> <span id="analysis-price-20"></span>
          </div>
        </div>
      </section>
      <h3>Generated Proposals</h3>
      <div class="result-card" style="margin-bottom: 24px; border: 2px solid #4f7cac;">
        <b style="color: #4f7cac; font-size: 1.1em;">Best Proposal</b>
        <pre id="best-proposal"></pre>
      </div>
      <div class="results-row">
        <div class="result-card">
          <b>Proposal 2:</b>
          <pre id="proposal-2"></pre>
        </div>
        <div class="result-card">
          <b>Proposal 3:</b>
          <pre id="proposal-3"></pre>
        </div>
      </div>
    </section>
  </div>
<script>
// Same-origin calls (backend served by FastAPI locally)
function api(path) { return path; }

async function fetchProposals() {
  try {
    const res = await fetch(api('/proposals'));
    if(!res.ok) throw new Error('Failed to load proposals: ' + res.status);
    const data = await res.json();
    const ul = document.getElementById('proposal-list');
    ul.innerHTML = '';
    data.forEach(p => {
      const li = document.createElement('li');
      li.textContent = p.name;
      ul.appendChild(li);
    });
  } catch (e) {
    console.error(e);
    document.getElementById('proposal-list').innerHTML = '<li>Could not load proposals.</li>';
  }
}
async function generate() {
  const errorBox = document.getElementById('error');
  errorBox.style.display = 'none';
  errorBox.textContent = '';
  const job = document.getElementById('job-desc').value;
  if(!job.trim()) { errorBox.textContent = 'Please enter a job description.'; errorBox.style.display='block'; return; }
  document.getElementById('loading').style.display = 'block';
  document.getElementById('results').style.display = 'none';
  try {
    const response = await fetch(api('/generate'), {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({job_description: job})
    });
    const text = await response.text();
    if(!response.ok) {
      throw new Error('Request failed: ' + response.status + ' ' + text);
    }
    let result;
    try { result = JSON.parse(text); } catch(parseErr) {
      throw new Error('Invalid JSON response: ' + text.slice(0, 200));
    }
    
    // Display analysis section
    const analysis = result.analysis || {};
    document.getElementById('analysis-country').textContent = analysis.country || 'Unknown';
    document.getElementById('analysis-legitimacy').textContent = analysis.legitimacy || 'Not available';
    document.getElementById('analysis-pricing').textContent = analysis.pricing_analysis || 'Not available';
    document.getElementById('analysis-time').textContent = analysis.time_estimate || 'Not available';
    document.getElementById('analysis-price-client').textContent = analysis.price_client_country || 'Not available';
    document.getElementById('analysis-price-20').textContent = analysis.price_20_per_hour || 'Not available';
    
    // Display best proposal
    const bestProposal = result.best_proposal || {};
    document.getElementById('best-proposal').textContent = bestProposal.text || 'Not available';
    
    // Display other proposals
    const otherProposals = result.other_proposals || [];
    document.getElementById('proposal-2').textContent = otherProposals[0]?.text || 'Not available';
    document.getElementById('proposal-3').textContent = otherProposals[1]?.text || 'Not available';

    document.getElementById('results').style.display = 'block';
  } catch (e) {
    console.error(e);
    errorBox.textContent = e.message;
    errorBox.style.display = 'block';
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}
document.getElementById('generate-btn').onclick = generate;
window.onload = fetchProposals;
</script>
</body>
</html>
